var Engine=function(){"use strict";function t(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var e={isNumeric:function(t){return!isNaN(parseFloat(t))&&isFinite(t)},radToDegree:function(t){return(t%=2*Math.PI)<0&&(t+=2*Math.PI),180*t/Math.PI},degreeToRad:function(t){return(t%=360)<0&&(t+=360),t/180*Math.PI},distanceBetween:function(t,e,i,n){return Math.sqrt(Math.pow(t-i,2)+Math.pow(e-n,2))},vectorToDegree:function(t,e){var i=Math.atan2(t,-e);return this.radToDegree(i)},position:function(t){if(this.isNumeric(t[0].x)&&this.isNumeric(t[0].y))return t[0];if(this.isNumeric(t[0])&&this.isNumeric(t[1]))return{x:t[0],y:t[1]};throw"請傳入角色(Sprite, Cursor)或是 X, Y 座標值"}},i=e;function n(t,e,n,s,o,r){t.constructor!==String&&t.constructor!==Array||(t={costumes:[].concat(t)}),this.x=i.isNumeric(t.x)?t.x:n.canvas.width/2,this.y=i.isNumeric(t.y)?t.y:n.canvas.height/2,this.direction=i.isNumeric(t.direction)?t.direction:90,this.scale=i.isNumeric(t.scale)?t.scale:1,this.layer=i.isNumeric(t.layer)?t.layer:0,this.opacity=i.isNumeric(t.opacity)?t.opacity:1,this.costumeId=i.isNumeric(t.costumeId)?t.costumeId:0,this.costumes=[].concat(t.costumes),this.hidden=!!t.hidden,this.rotationStyle=["full","flipped","fixed"].includes(t.rotationStyle)?t.rotationStyle:"full",this.width=1,this.height=1,this._onTickFuncs=[],this._deleted=!1,this._animation={frames:[],rate:5,timer:0},this._eventList=e,this._renderer=n,this._loader=s,this._touchSystem=o,r._sprites.push(this)}n.prototype={stepForward:function(t){var e=i.degreeToRad(this.direction);this.x+=Math.sin(e)*t,this.y-=Math.cos(e)*t},moveTo:function(){var t=i.position(arguments);this.x=t.x,this.y=t.y},move:function(t,e){this.x+=t,this.y+=e},toward:function(){var t=i.position(arguments);this.direction=i.vectorToDegree(t.x-this.x,t.y-this.y)},touched:function(){if(arguments[0].constructor===Array){for(let t=0;t<arguments[0].length;t++)if(this._isTouched(arguments[0][t]))return!0;return!1}return this._isTouched.apply(this,arguments)},distanceTo:function(){var t=i.position(arguments);return i.distanceBetween(this.x,this.y,t.x,t.y)},forever:function(t){this._onTickFuncs.push(t)},on:function(){var t=arguments[0],e=this._eventList;if(e.validEventName(t))return"touch"===t?e.register(t,this,arguments[1],arguments[2]):["mousedown","mouseup","click","hover"].includes(t)?e.register(t,this,arguments[1]):["keydown","keydup","holding"].includes(t)?e.register(t,arguments[1],arguments[2]):"listen"===t?e.register(t,arguments[1],this,arguments[2]):void 0},destroy:function(){this._deleted=!0},nextCostume:function(){this.costumeId+=1,this.costumeId>=this.costumes.length&&(this.costumeId=0)},bounceEdge:function(){var t=this._renderer.canvas;this.x<0?(this.x=0,this.direction>180&&this.direction>0&&(this.direction=-this.direction)):this.x>t.width&&(this.x=t.width,this.direction<180&&(this.direction=-this.direction)),this.y<0?(this.y=0,(this.direction<90||this.direction>270)&&(this.direction=180-this.direction)):this.y>t.height&&(this.y=t.height,(this.direction>90||this.direction<270)&&(this.direction=180-this.direction))},animate:function(t,e,i){this._animation={frames:t,rate:e||5,callback:i,timer:0}},getCostumeImage:function(){var t=this.costumes[this.costumeId];return this._loader.getImgFromCache(t)},update:function(){this._updateDirection(),this._updateSize(),this._updateFrames();for(let t=0;t<this._onTickFuncs.length;t++)this._onTickFuncs[t].call(this)},_updateDirection:function(){this.direction=this.direction%360,this.direction<0&&(this.direction+=360)},_updateSize:function(){var t=this.getCostumeImage();this.width=t.width*this.scale,this.height=t.height*this.scale},_updateFrames:function(){var t=this._animation;if(t.frames.length>0){var e=(new Date).getTime();e>=t.timer+1e3/t.rate&&(t.timer=e,this.costumeId=t.frames.shift(),t.frames.length<=0&&t.callback&&t.callback())}},_isTouched:function(){if(arguments[0]instanceof n)return this._touchSystem.isTouch(this,arguments[0]);var t=i.position(arguments);return this._touchSystem.isTouchDot(this,t.x,t.y)}},n.prototype.when=n.prototype.on,n.prototype.always=n.prototype.forever;var s=n;function o(){this._sprites=[]}o.prototype.runOnTick=function(){this.each((function(){this.update()}))},o.prototype.each=function(t){var e=this._sprites;for(let i=0;i<e.length;i++)t.call(e[i],e[i])},o.prototype.removeDeletedSprites=function(){var t=this._sprites;for(let e=0;e<t.length;e++)t[e]._deleted&&t.splice(e,1)},o.prototype.clear=function(){this._sprites=[]};var r=o;const h=["click","mousedown","mouseup","keydown","keyup","holding","touch","hover"];function a(t){this.pool=[],this.io=t}a.prototype={traverse:function(){var t=this.io,e=this;this.pool.forEach((function(i){"touch"===i.event?e.touchJudger(i.sprite,i.handler,i.targets):"click"===i.event?e.mouseJudger(i.sprite,i.handler,t.clicked):"hover"===i.event?e.hoverJudger(i.sprite,i.handler,t.cursor):"mousedown"===i.event?e.mouseJudger(i.sprite,i.handler,t.mousedown):"mouseup"===i.event?e.mouseJudger(i.sprite,i.handler,t.mouseup):"holding"===i.event?e.keyJudger(i.key,i.handler,t.holding):"keyup"===i.event?e.keyJudger(i.key,i.handler,t.keyup):"keydown"===i.event&&e.keyJudger(i.key,i.handler,t.keydown)})),this.pool=this.pool.filter((function(t){return!(t.sprite&&t.sprite._deleted)})),t.clearEvents()},register:function(){if(this.validEventName(arguments[0])){var t=arguments[0],e={event:t,handler:arguments[arguments.length-1]};"touch"===t?(e.sprite=arguments[1],e.targets=arguments[2]instanceof Array?arguments[2]:[arguments[2]]):"hover"===t?e.sprite=arguments[1]instanceof Array?arguments[1]:[arguments[1]]:["keydown","keyup","holding"].includes(t)?e.key=arguments[1]instanceof Function?"any":arguments[1]:["mousedown","mouseup","click"].includes(t)?e.sprite=arguments[1]instanceof Function?null:arguments[1]instanceof Array?arguments[1]:[arguments[1]]:"listen"===t&&(e.message=arguments[1],e.sprite=arguments[2]),this.pool.push(e)}},emit:function(t){for(let i=0;i<this.pool.length;i++){var e=this.pool[i];"listen"==e.event&&e.message==t&&e.handler.call(e.sprite)}},mouseJudger:function(t,e,i){i.x&&i.y&&(t?t.forEach((function(t){t.touched(i.x,i.y)&&e.call(t)})):e())},keyJudger:function(t,e,i){i[t]&&e()},touchJudger:function(t,e,i){i.forEach((function(i){t.touched(i)&&e.call(t,i)}))},hoverJudger:function(t,e,i){t.forEach((function(t){t.touched(i.x,i.y)&&e.call(t)}))},validEventName:function(t){return!1===h.includes(t)&&console.error("`"+t+"` 事件是不支援的，請檢查是否符合以下支援的事件\n "+this.VALID_EVENT_NAMES.join(", ")),!0},VALID_EVENT_NAMES:h};var c=a;function u(){this.fps=0,this._lastFrameUpdatedTime=(new Date).getTime()}u.prototype.updateFPS=function(){var t=(new Date).getTime();this.fps=Math.round(1e3/(t-this._lastFrameUpdatedTime)),this._lastFrameUpdatedTime=t};var d=u;var l=function(t){var e=!1;!function i(){e&&t(),requestAnimationFrame(i)}(),this.start=function(){e=!0},this.stop=function(){e=!1}},f=e;function p(t,e){this.canvas=t,this.ctx=t.getContext("2d"),this.loader=e}p.prototype={clear:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)},drawSprites:function(t){t._sprites.sort((function(t,e){return t.layer-e.layer}));var e=this;t.each((function(t){e.drawInstance(t)}))},drawInstance:function(t){if(!t.hidden){var e=this.ctx,i=t.getCostumeImage(),n=f.degreeToRad(t.direction-90);if(e.globalAlpha=t.opacity,"flipped"===t.rotationStyle){if(t.direction>180)return e.translate(2*t.x,0),e.scale(-1,1),e.drawImage(i,t.x-t.width/2,t.y-t.height/2,t.width,t.height),e.scale(-1,1),e.translate(2*-t.x,0),void(e.globalAlpha=1);n=0}if("fixed"===t.rotationStyle)n=0;e.translate(t.x,t.y),e.rotate(n),e.drawImage(i,-t.width/2,-t.height/2,t.width,t.height),e.rotate(-n),e.translate(-t.x,-t.y),e.globalAlpha=1}},drawBackdrop:function(t,e,i,n,s){if(t.includes(".")){var o=this.loader.getImgFromCache(t);this.ctx.drawImage(o,e||0,i||0,n||o.width,s||o.height)}else t&&(this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))}};var g=p;function y(t){this.source=null,this.gainNode=t.createGain(),this.context=t,this.isLoop=!1,this.bufferData=null,this.volume=1,this.gainNode.connect(t.destination)}y.prototype={setVolume:function(t){if(t<0)return console.error("無效的音量值");this.volume=t,this.gainNode.gain.value=t},setBufferData:function(t){this.bufferData=t},setLoop:function(t){this.isLoop=t},mute:function(t){this.gainNode.gain.value=t?0:this.volume},pause:function(){this.source.playbackRate.value=Number.MIN_VALUE},resume:function(){this.source.playbackRate.value=1},play:function(){this.source=this.context.createBufferSource(),this.source.buffer=this.bufferData,this.source.loop=this.isLoop,this.source.connect(this.gainNode),this.source.start(0)},stop:function(){this.source.stop()}};var w=y;function x(t){this.context=new(window.AudioContext||window.webkitAudioContext),this.soundNodes=[],this.loader=t,this.sounds=t.sounds,this.muted=!1}x.prototype={play:function(t,e){e=void 0!==e&&e;var i=new w(this.context);if(this.sounds[t]){var n=this.sounds[t];i.setBufferData(n),i.setLoop(e),this.soundNodes.push(i),i.play()}else{var s=this;this.loader._xhrLoad(t,(function(n){var o=n.response;s.context.decodeAudioData(o,(function(n){s.sounds[t]=n,i.setBufferData(n),i.setLoop(e),s.soundNodes.push(i),i.play()}))}))}return i},setVolume:function(t){if(t<0)return console.error("無效的音量值");for(let e=0;e<this.soundNodes.length;e++){this.soundNodes[e].setVolume(t)}},mute:function(t){for(let e=0;e<this.soundNodes.length;e++){this.soundNodes[e].mute(t)}},pause:function(){this.context.suspend()},resume:function(){this.context.resume()},stop:function(){for(let t=0;t<this.soundNodes.length;t++){this.soundNodes[t].stop()}}};var m=x;const A="data:image/jpeg;base64,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";function v(){this.context=new(window.AudioContext||window.webkitAudioContext),this.loaded=0,this.paths=[],this.sounds={},this.images={},this.completeFunc,this.progressFunc}v.prototype={preload:function(t,e,i){if(0===t.length)return e();this.paths=t,this.completeFunc=e,this.progressFunc=i;for(let e=0;e<t.length;e++){var n=t[e],s=n.split(".").pop();["jpg","jpeg","png","gif","svg"].includes(s)&&this._loadImage(n),["mp3","ogg","wav","midi"].includes(s)&&this._loadSound(n)}},getImgFromCache:function(t){var e=this.images[t];return e||((e=new Image).src=t,e.onerror=function(t){console.error(this.src.split("/").pop()+" 素材載入失敗，請確認是否填寫正確！ \n 圖片路徑："+this.src),e.src=A},this.images[t]=e),e},_loadImage:function(t){var e=this,i=new Image;i.src=t,i.crossOrigin="anonymous",i.onload=function(){e._loaded()},i.onerror=function(t){console.error(this.src.split("/").pop()+" 素材載入失敗，請確認是否填寫正確！ \n 圖片路徑："+this.src),img.src=A},this.images[t]=i},_loadSound:function(t){var e=this;this._xhrLoad(t,(function(i){var n=i.response;e.context.decodeAudioData(n,(function(i){e.sounds[t]=i,e._loaded()}))}))},_loaded:function(){this.loaded+=1,this.progressFunc&&this.progressFunc(this.loaded,this.paths.length),this.loaded>=this.paths.length&&this.completeFunc&&this.completeFunc()},_xhrLoad:function(t,e){var i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onload=function(){e(i)},i.onerror=function(){console.error(i)},i.send()}};var k=v;function S(t){const e={Backspace:"backspace",Tab:"tab",Enter:"enter",Shift:"shift",Control:"ctrl",Alt:"alt",Pause:"pause/break",CapsLock:"caps lock",Escape:"esc"," ":"space",PageUp:"page up",PageDown:"page down",End:"end",Home:"home",ArrowLeft:"left",ArrowUp:"up",ArrowRight:"right",ArrowDown:"down",Insert:"insert",Delete:"delete",Meta:"command"};return t.key in e?e[t.key]:t.key}function B(t,e){var i=this.cursor={x:0,y:0,isDown:!1,left:!1,right:!1},n=this.clicked={x:null,y:null},s=this.mousedown={x:null,y:null},o=this.mouseup={x:null,y:null},r=this.keyup={any:!1},h=this.keydown={any:!1},a=this.holding={any:!1,count:0},c=1,u=1;setInterval((function(){var e=t.getBoundingClientRect();c=e.width/t.width,u=e.height/t.height}),100);var d=!!e.debugMode;function l(e){return{x:(e.pageX-t.offsetLeft)/c,y:(e.pageY-t.offsetTop)/u}}t.setAttribute("tabindex","1"),t.style.outline="none",t.oncontextmenu=function(){return!1},t.addEventListener("mousedown",(function(t){0==t.button&&(i.left=!0),2==t.button&&(i.right=!0),i.isDown=!0,s.x=t.offsetX/c,s.y=t.offsetY/u})),t.addEventListener("mouseup",(function(t){0==t.button&&(i.left=!1),2==t.button&&(i.right=!1),i.isDown=i.left||i.right,o.x=t.offsetX/c,o.y=t.offsetY/u})),t.addEventListener("mousemove",(function(t){i.x=t.offsetX/c,i.y=t.offsetY/u})),t.addEventListener("touchstart",(function(t){i.isDown=!0;var e=l(t.changedTouches[0]);i.x=s.x=e.x,i.y=s.y=e.y})),t.addEventListener("touchend",(function(t){i.isDown=!1;var e=l(t.changedTouches[0]);i.x=o.x=e.x,i.y=o.y=e.y})),t.addEventListener("touchmove",(function(t){var e=l(t.changedTouches[0]);i.x=e.x,i.y=e.y})),t.addEventListener("click",(function(t){n.x=t.offsetX/c,n.y=t.offsetY/u,d&&console.log("Clicked! cursor:"+JSON.stringify(i))})),t.addEventListener("keydown",(function(t){var e=S(t);a[e]||(a.any=(a.count+=1)>0),h.any=!0,h[e]=!0,a[e]=!0,d&&console.log("Keydown! key:"+e)})),t.addEventListener("keyup",(function(t){var e=S(t);a.any=(a.count-=1)>0,r.any=!0,r[e]=!0,a[e]=!1,d&&console.log("Keyup! key:"+e)}))}B.prototype.clearEvents=function(){this.clicked.x=null,this.clicked.y=null,this.mousedown.x=null,this.mousedown.y=null,this.mouseup.x=null,this.mouseup.y=null;for(let t in this.keydown)this.keydown[t]=!1,this.keyup[t]=!1};var b=B;function T(t,e){this.ctx=t.getContext("2d"),this.size=1,this.color="black",this.fillColor=null,this.settings=e,this.shapes=[],this.texts=[]}T.prototype={drawShapes:function(){var t,e=this.ctx;for(let i=0;i<this.shapes.length;i++)t=this.shapes[i],e.lineWidth=t.size,e.strokeStyle=t.color,e.fillStyle=t.fillColor,"line"==t.type?this._drawLine(t.x1,t.y1,t.x2,t.y2):"circle"==t.type?this._drawCircle(t.x,t.y,t.r):"triangle"==t.type?this._drawTriangle(t.x1,t.y1,t.x2,t.y2,t.x3,t.y3):"rect"==t.type?this._drawRect(t.x,t.y,t.w,t.h):"polygon"==t.type&&this._drawPolygon.apply(this,t.points);this.shapes=[]},drawTexts:function(){for(let t=0;t<this.texts.length;t++){let e=this.texts[t];this._drawText(e.text,e.x,e.y,e.color,e.size,e.font)}this.texts=[]},drawText:function(t,e,i,n,s,o){if(e=null==e?10:e,i=null==i?10:i,n=n||"black",s=s||16,o=o||"Arial",!this.settings.autoRendering)return this._drawText(t,e,i,n,s,o);this._addText({text:t,x:e,y:i,color:n,size:s,font:o})},drawLine:function(t,e,i,n){if(!this.settings.autoRendering)return this._drawLine(t,e,i,n);var s={};s.x1=t,s.y1=e,s.x2=i,s.y2=n,s.type="line",this._addShape(s)},drawCircle:function(t,e,i){if(!this.settings.autoRendering)return this._drawCircle(t,e,i);var n={};n.x=t,n.y=e,n.r=i,n.type="circle",this._addShape(n)},drawTriangle:function(t,e,i,n,s,o){if(!this.settings.autoRendering)return this._drawTriangle(t,e,i,n,s,o);var r={};r.x1=t,r.y1=e,r.x2=i,r.y2=n,r.x3=s,r.y3=o,r.type="triangle",this._addShape(r)},drawRect:function(t,e,i,n){if(!this.settings.autoRendering)return this._drawRect(t,e,i,n);var s={};s.x=t,s.y=e,s.w=i,s.h=n,s.type="rect",this._addShape(s)},drawPolygon:function(){if(!this.settings.autoRendering)return this._drawPolygon.apply(this,arguments);var t={};t.points=Array.prototype.slice.call(arguments),t.type="polygon",this._addShape(t)},_drawText:function(t,e,i,n,s,o){this.settings.autoRendering||this._setPenAttr(),this.ctx.textBaseline="top",this.ctx.font=s+"px "+o,this.ctx.fillStyle=n,this.ctx.fillText(t,e,i)},_drawLine:function(t,e,i,n){this.settings.autoRendering||this._setPenAttr(),this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,n),this.ctx.closePath(),this.size&&this.ctx.stroke(),this.fillColor&&this.ctx.fill()},_drawCircle:function(t,e,i){this.settings.autoRendering||this._setPenAttr(),this.ctx.beginPath(),this.ctx.arc(t,e,i,0,2*Math.PI),this.ctx.closePath(),this.size&&this.ctx.stroke(),this.fillColor&&this.ctx.fill()},_drawTriangle:function(t,e,i,n,s,o){this.settings.autoRendering||this._setPenAttr(),this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(i,n),this.ctx.lineTo(s,o),this.ctx.closePath(),this.size&&this.ctx.stroke(),this.fillColor&&this.ctx.fill()},_drawRect:function(t,e,i,n){this.settings.autoRendering||this._setPenAttr(),this.ctx.beginPath(),this.ctx.moveTo(t,e),this.ctx.lineTo(t+i,e),this.ctx.lineTo(t+i,e+n),this.ctx.lineTo(t,e+n),this.ctx.closePath(),this.size&&this.ctx.stroke(),this.fillColor&&this.ctx.fill()},_drawPolygon:function(){this.settings.autoRendering||this._setPenAttr();var t=Array.prototype.slice.call(arguments);this.ctx.beginPath(),this.ctx.moveTo(t[0],t[1]);for(let e=2;e<t.length;e+=2)this.ctx.lineTo(t[e],t[e+1]);this.ctx.closePath(),this.size&&this.ctx.stroke(),this.fillColor&&this.ctx.fill()},_setPenAttr:function(){this.ctx.lineWidth=this.size,this.ctx.strokeStyle=this.color,this.ctx.fillStyle=this.fillColor},_addShape:function(t){t.size=this.size,t.color=this.color,t.fillColor=this.fillColor,this.shapes.push(t)},_addText:function(t){this.texts.push(t)}};var F=T,R=e,M=s,_=g;function D(t,e,i){this.canvas=t,this.ctx=t.getContext("2d"),this.renderer=new _(t,e),this.settings=i}D.prototype={isTouchDot:function(t,e,i){return this.isTouch(t,{x:e,y:i,width:2*this.settings.precision,height:2*this.settings.precision,direction:0,area:1})},isTouch:function(t,e){if(t.hidden||t._deleted||e.hidden||e._deleted||t===e)return!1;var i=this.getBoxOf(t),n=this.getBoxOf(e);if(!1===this.AABBJudger(i,n))return!1;var s=this.reduceAccuracy(t),o=this.reduceAccuracy(e),r=i.area<n.area?i:n;this.reduceAccuracy(r);let h=this.pixelJudger(t,e,r);return s(),o(),h},getBoxOf:function(t){var e={x:t.x,y:t.y,area:t.width*t.height};if(90===t.direction||270===t.direction||"full"!==t.rotationStyle)return e.width=t.width,e.height=t.height,e;if(0===t.direction||180===t.direction)return e.width=t.height,e.height=t.width,e;var i=Math.sqrt(t.width*t.width+t.height*t.height),n=Math.asin(t.width/i),s=R.degreeToRad(t.direction)-n,o=R.degreeToRad(t.direction)+n,r=Math.abs(Math.sin(s)),h=Math.abs(Math.cos(s)),a=Math.abs(Math.sin(o)),c=Math.abs(Math.cos(o));return e.width=Math.max(h,c)*i,e.height=Math.max(r,a)*i,e.area=e.width*e.height,e},AABBJudger:function(t,e){return Math.abs(t.x-e.x)<(t.width+e.width)/2&&Math.abs(t.y-e.y)<(t.height+e.height)/2},pixelJudger:function(t,e,i){if(i.width<1||i.height<1)return!1;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalCompositeOperation="source-over",this.renderer.drawInstance(t),this.ctx.globalCompositeOperation="source-in",e instanceof M?this.renderer.drawInstance(e):this.ctx.fillRect(e.x,e.y,1,1);var n=this.ctx.getImageData(i.x-i.width/2,i.y-i.height/2,i.width,i.height).data;for(let t=0;t<n.length;t+=4)if(n[t+3]>0)return!0;return!1},reduceAccuracy:function(t){var e=this.settings.precision,i=t.x,n=t.y,s=t.width,o=t.height,r=t.scale;return t.x/=e,t.y/=e,t.width/=e,t.height/=e,t.scale/=e,function(){t.x=i,t.y=n,t.width=s,t.height=o,t.scale=r}}};var E=s,L=r,I=c,C=d,P=l,N=g,K=m,H=k,J=b,Q=F,j=D;var G=function(t,e){var i=document.getElementById(t),n=document.createElement("canvas");n.width=i.width,n.height=i.height;var s={debugMode:e||!1,autoRendering:!0,precision:1},o={path:"#ffffff"},r=[],h=new H,a=new L,c=new C,u=new J(i,s),d=new I(u),l=new N(i,h),f=new K(h),p=new Q(i,s),g=new j(n,h,s);function y(){d.traverse();for(let t=0;t<r.length;t++)r[t]();a.removeDeletedSprites(),a.runOnTick(),c.updateFPS(),s.autoRendering&&(l.drawBackdrop(o.path,o.x,o.y,o.w,o.h),p.drawShapes(),l.drawSprites(a),p.drawTexts())}var w=new P(y);function x(t,e,i,n,s){o.path=t,o.x=e,o.y=i,o.w=n,o.h=s}function m(t){r.push(t)}var A={set:function(t){t.width&&(i.width=t.width),t.height&&(i.height=t.height),t.precision&&(s.precision=t.precision),(t.precision||t.width||t.height)&&(n.width=i.width/s.precision,n.height=i.height/s.precision),null!=t.autoRendering&&(s.autoRendering=!!t.autoRendering)},preload:h.preload.bind(h),start:w.start.bind(w),stop:function(){w.stop(),f.stop()},createSprite:function(t){return arguments.length>1&&(t=Array.from(arguments)),new E(t,d,l,h,g,a)},createSound:f.play.bind(f),setBackground:x,setBackdrop:x,inspector:c,forever:m,update:m,always:m,sound:f,cursor:u.cursor,key:u.holding,when:d.register.bind(d),on:d.register.bind(d),broadcast:d.emit.bind(d),pen:p,print:p.drawText.bind(p),drawText:p.drawText.bind(p),drawBackdrop:l.drawBackdrop.bind(l),drawBackground:l.drawBackdrop.bind(l),drawSprites:l.drawSprites.bind(l),clear:l.clear.bind(l),Sprite:E,gameloop:y};return s.debugMode&&(A.eventList=d),A};return t(G)}();
